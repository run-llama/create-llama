name: Python Release

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - "llama-index-server/**"
      - ".github/workflows/python-release.yml"

concurrency: ${{ github.workflow }}-${{ github.ref }}

jobs:
  release:
    name: Python Release
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./llama-index-server

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Poetry
        run: |
          curl -sSL https://install.python-poetry.org | python3 -

      - name: Install dependencies
        run: poetry install

      - name: Get current version
        id: get_version
        run: |
          version=$(poetry version -s)
          echo "current_version=${version}" >> "$GITHUB_OUTPUT"

      - name: Create Release PR
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore(release): prepare release ${{ steps.get_version.outputs.current_version }}"
          title: "Release llama-index-server v${{ steps.get_version.outputs.current_version }}"
          body: |
            This PR was automatically created to release a new version of the llama-index-server package.

            Version: ${{ steps.get_version.outputs.current_version }}

            Please review the changes and merge to trigger the release.
          branch: release/python-v${{ steps.get_version.outputs.current_version }}
          base: main
          labels: release, python
